<?xml version="1.0" encoding="UTF-8" standalone="yes"?> 
<Analytics>
	<Name>Hub_Analytics_Script</Name> 
        <Script> 
        	 
        	 
        	 
		create temporary table NBAPIRequestSummaryData using CarbonJDBC options (dataSource "WSO2AM_STATS_DB", tableName "NB_API_REQUEST_SUMMARY");

		create temporary table NBAPIRequestData USING CarbonAnalytics OPTIONS(tableName "COM_WSO2TELCO_STATISTICS_NORTHBOUND_REQUEST");

		insert OVERWRITE TABLE NBAPIRequestSummaryData SELECT
		    facet4(requestTime,userId,requestId,resourcePath),
		    api,
		    api_version,
		    version,
		    apiPublisher,
		    COALESCE(consumerKey,'-'),
		    userId,
		    context,
		    request as request_count,
		    hostName,
		    resourcePath,
		    method,
		    requestId,
		    chargeAmount,
		    purchaseCategoryCode,
		    jsonBody,
		    cast(getYear(requestTime) as String) as year,
		    cast(getMonth(requestTime) as String) as month,
		    cast(getDay(requestTime) as String) as day,
		    getFormattedDate(requestTime,"yyyy-MM-dd HH:mm:ss")
		    from NBAPIRequestData;



		create temporary table NBAPIResponseSummaryData using CarbonJDBC options (dataSource "WSO2AM_STATS_DB", tableName "NB_API_RESPONSE_SUMMARY");

		create temporary table NBAPIResponseData USING CarbonAnalytics OPTIONS(tableName "COM_WSO2TELCO_STATISTICS_NORTHBOUND_RESPONSE");

		INSERT OVERWRITE TABLE NBAPIResponseSummaryData SELECT 
		    facet4(responseTime,userId,requestId,resourcePath) ,
		    api,
		    api_version,
		    version,
		    apiPublisher,
		    COALESCE(consumerKey,'-'),
		    userId,
		    context,
		    serviceTime,
		    response,
		    hostName,
		    resourcePath,
		    method,
		    requestId,
		    responseCode,
		    msisdn,
		    operatorRef,
		    chargeAmount,
		    purchaseCategoryCode,
		    exceptionId,
		    exceptionMessage,
		    jsonBody,
		    cast(getYear(responseTime) as String) as year,
		    cast(getMonth(responseTime) as String) as month,
		    cast(getDay(responseTime) as String) as day,
		    getFormattedDate(responseTime,"yyyy-MM-dd HH:mm:ss"),
		    operationType,
		    merchantId,
		    category,
		    subCategory
		    FROM NBAPIResponseData;



		create temporary table SBAPIRequestSummaryData using CarbonJDBC options (dataSource "WSO2AM_STATS_DB", tableName "SB_API_REQUEST_SUMMARY");

        	create temporary table SBAPIRequestData USING CarbonAnalytics OPTIONS(tableName "COM_WSO2TELCO_STATISTICS_SOUTHBOUND_REQUEST");
                
		INSERT OVERWRITE TABLE SBAPIRequestSummaryData select
		    facet4(requestTime,userId,requestId,resourcePath),
		    api,
		    api_version,
		    version,
		    apiPublisher,
		    COALESCE(consumerKey,'-'),
		    userId,
		    context,
		    request as request_count,
		    hostName,
		    resourcePath,
		    method,
		    requestId,
		    operatorId,
		    chargeAmount,
		    purchaseCategoryCode,
		    jsonBody,
			taxAmount, 
			channel, 
			onBehalfOf, 
			description, 
			transactionOperationStatus, 
			referenceCode,
			cast(getYear(requestTime) as String) as year,
		    cast(getMonth(requestTime) as String) as month,
		    cast(getDay(requestTime) as String) as day,
		    getFormattedDate(requestTime,"yyyy-MM-dd HH:mm:ss")
		    from SBAPIRequestData; 




		create temporary table SBAPIResponseSummaryData using CarbonJDBC options (dataSource "WSO2AM_STATS_DB", tableName "SB_API_RESPONSE_SUMMARY");

		create temporary table SBAPIResponseData USING CarbonAnalytics OPTIONS(tableName "COM_WSO2TELCO_STATISTICS_SOUTHBOUND_RESPONSE");

		INSERT OVERWRITE TABLE  SBAPIResponseSummaryData SELECT
		    facet4(responseTime,userId,requestId,resourcePath),
		    api,
		    api_version,
		    version,
		    apiPublisher,
		    COALESCE(consumerKey,'-'),
		    userId,
		    context,
		    serviceTime,
		    response as response_count,
		    hostName,
		    resourcePath,
		    method,
		    requestId,
		    operatorId,
		    responseCode,
		    msisdn,
		    operatorRef,
		    chargeAmount,
		    purchaseCategoryCode,
		    exceptionId,
		    exceptionMessage,
		    jsonBody,
			taxAmount, 
			channel, 
			onBehalfOf, 
			description,
			ussdAction, 
			ussdSessionId, 
			transactionOperationStatus, 
			referenceCode, 
			destinationAddress,
			senderAddress,
			message,
			date_Time ,
			resourceURL ,
			message_Id, 
			spConsumerKey,
			spOperatorId,
			spUserId,,
		    cast(getYear(responseTime) as String) as year,
		    cast(getMonth(responseTime) as String) as month,
		    cast(getDay(responseTime) as String) as day,
		    getFormattedDate(responseTime,"yyyy-MM-dd HH:mm:ss"),
		    operationType,
		    merchantId,
		    category,
		    subCategory
		    from SBAPIResponseData;
                            
	</Script>
        
        <CronExpression>0 0/5 * 1/1 * ? *</CronExpression> 
</Analytics> 
